<!--
  Minimaler Preisindikator (nur: Niedrigster, Höchster, Aktuell + Einschätzung)
  — Drop‑in: Kopiere diesen Block an die Stelle des alten Widgets.
  — Daten als data‑Attribute übergeben (siehe data‑* unten).
  — Keine Tabelle, keine zusätzlichen Kennzahlen.
-->
<section id="preisindikator" class="bpr-price-indicator" aria-labelledby="preisindikator__title"
  data-currency="EUR"
  data-product-name="7 Wonders"
  data-product-url="https://brettspielpreisradar.de/spiel/7-wonders/"
  data-product-image=""
  data-current="19.99"
  data-low="18.49"
  data-high="28.99"
  data-offer-url="https://example.com/angebot"
  data-availability="InStock">

  <div class="bpr-card">
    <header class="bpr-header">
      <h2 id="preisindikator__title" class="bpr-title">Preisindikator</h2>
      <div class="bpr-badge" role="status" aria-live="polite" aria-atomic="true">
        <span class="bpr-badge__dot" aria-hidden="true"></span>
        <span class="bpr-badge__label">–</span>
      </div>
    </header>

    <div class="bpr-compact">
      <div class="bpr-current" role="group" aria-label="Aktueller Preis">
        <div class="bpr-current__label">Aktuell</div>
        <div class="bpr-current__value" data-field="current">– €</div>
        <a class="bpr-cta" href="#" rel="nofollow sponsored" data-field="offerUrl">Zum Angebot</a>
      </div>

      <div class="bpr-gauge" role="img" aria-label="Position des aktuellen Preises zwischen Niedrigstem und Höchstem">
        <div class="bpr-gauge__track" aria-hidden="true"></div>
        <div class="bpr-gauge__marker" aria-hidden="true"><span>Jetzt</span></div>
        <div class="bpr-gauge__legend" aria-hidden="true">
          <div class="bpr-gauge__legend-item">
            <small>Niedrigster</small>
            <strong data-field="low">– €</strong>
          </div>
          <div class="bpr-gauge__legend-item">
            <small>Höchster</small>
            <strong data-field="high">– €</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  :root {
    --bpr-bg: #0b0c0f;
    --bpr-card: #11131a;
    --bpr-text: #e9ecf1;
    --bpr-muted: #a3adbd;
    --bpr-border: #222633;
    --bpr-good: #22c55e;
    --bpr-mid: #eab308;
    --bpr-high: #ef4444;
    --bpr-link: #60a5fa;
  }
  @media (prefers-color-scheme: light) {
    :root {
      --bpr-bg: #ffffff;
      --bpr-card: #f8fafc;
      --bpr-text: #0f172a;
      --bpr-muted: #475569;
      --bpr-border: #e2e8f0;
      --bpr-link: #2563eb;
    }
  }
  .bpr-price-indicator { color: var(--bpr-text); }
  .bpr-card { border: 1px solid var(--bpr-border); background: var(--bpr-card); border-radius: 16px; padding: clamp(16px, 2.5vw, 22px); box-shadow: 0 6px 22px rgba(0,0,0,.12); }

  .bpr-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
  .bpr-title { margin:0; font-size: clamp(18px, 2.2vw, 22px); letter-spacing:.2px; }
  .bpr-badge { display:inline-flex; gap:.5rem; align-items:center; border:1px solid var(--bpr-border); border-radius:999px; padding:6px 10px; font-weight:700; font-size:.9rem; background: rgba(255,255,255,.03); }
  .bpr-badge__dot { width:10px; height:10px; border-radius:999px; background: var(--bpr-mid); box-shadow: 0 0 0 4px rgba(0,0,0,.05) inset; }
  .bpr-badge__label { color: var(--bpr-muted); }

  .bpr-compact { display:grid; grid-template-columns: 1fr; gap:18px; }
  @media (min-width: 780px) { .bpr-compact { grid-template-columns: .85fr 1.15fr; gap:24px; } }

  .bpr-current { display:grid; align-content:start; gap:8px; }
  .bpr-current__label { color: var(--bpr-muted); font-weight:600; }
  .bpr-current__value { font-size: clamp(28px, 5vw, 40px); font-weight:800; letter-spacing:.2px; }
  .bpr-cta { display:inline-flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; text-decoration:none; border:1px solid var(--bpr-border); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)); font-weight:700; color: var(--bpr-text); width:max-content; }
  .bpr-cta:hover { transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.12); }
  @media (prefers-reduced-motion: reduce) { .bpr-cta:hover { transform:none; } }

  .bpr-gauge { position: relative; }
  .bpr-gauge__track { height: 14px; border-radius: 999px; background: linear-gradient(90deg, var(--bpr-good), var(--bpr-mid) 50%, var(--bpr-high)); opacity:.9; }
  .bpr-gauge__marker { position:absolute; top: -3px; left:0; transform: translate(-50%, 0); background: var(--bpr-card); border:1px solid var(--bpr-border); padding: 2px 6px; border-radius: 8px; font-size:.75rem; font-weight:700; white-space:nowrap; }
  .bpr-gauge__legend { display:flex; justify-content:space-between; gap:12px; margin-top:8px; }
  .bpr-gauge__legend-item { display:grid; }
  .bpr-gauge__legend-item small { color: var(--bpr-muted); }
  .bpr-gauge__legend-item strong { font-weight:800; }
</style>

<script>
(function(){
  const el = document.querySelector('#preisindikator');
  if(!el) return;

  // Daten
  const currency = el.dataset.currency || 'EUR';
  const name = el.dataset.productName || document.querySelector('h1')?.textContent?.trim() || 'Produkt';
  const url = el.dataset.productUrl || location.href;
  const image = el.dataset.productImage || '';
  const offerUrl = el.dataset.offerUrl || '#';
  const availability = el.dataset.availability || 'InStock';

  const cur = Number(el.dataset.current || 0);
  let low = Number(el.dataset.low || NaN);
  let high = Number(el.dataset.high || NaN);

  // Fallback: falls low/high nicht gesetzt sind, optional aus history ableiten
  if((isNaN(low) || isNaN(high)) && el.dataset.history){
    try{
      const hist = JSON.parse(el.dataset.history);
      if(Array.isArray(hist) && hist.length){
        low = Math.min(...hist); high = Math.max(...hist);
      }
    }catch(e){}
  }

  if(isNaN(low)) low = cur;
  if(isNaN(high)) high = cur;
  const range = Math.max(0.01, high - low);
  const pos = Math.max(0, Math.min(1, (cur - low) / range)); // 0 = niedrigster, 1 = höchster

  // Einschätzung je nach Position
  let label = 'fair';
  let tone = 'mid';
  if(pos <= 0.2){ label = 'sehr günstig'; tone = 'good'; }
  else if(pos <= 0.4){ label = 'günstig'; tone = 'good'; }
  else if(pos <= 0.6){ label = 'fair'; tone = 'mid'; }
  else if(pos <= 0.8){ label = 'hoch'; tone = 'high'; }
  else { label = 'sehr hoch'; tone = 'high'; }

  const nf = new Intl.NumberFormat('de-DE', { style: 'currency', currency });

  // DOM füllen (nur drei Zahlen sichtbar)
  el.querySelector('[data-field="current"]').textContent = nf.format(cur);
  el.querySelector('[data-field="low"]').textContent = nf.format(low);
  el.querySelector('[data-field="high"]').textContent = nf.format(high);
  const cta = el.querySelector('[data-field="offerUrl"]');
  if(cta) cta.href = offerUrl || '#';

  // Badge
  const badge = el.querySelector('.bpr-badge');
  const dot = badge?.querySelector('.bpr-badge__dot');
  const lab = badge?.querySelector('.bpr-badge__label');
  if(lab) lab.textContent = label;
  if(dot){
    dot.style.background = tone === 'good' ? 'var(--bpr-good)' : tone === 'mid' ? 'var(--bpr-mid)' : 'var(--bpr-high)';
  }

  // Gauge Marker
  const marker = el.querySelector('.bpr-gauge__marker');
  if(marker){ marker.style.left = `${pos * 100}%`; }

  // A11y: Zusammenfassung am Widget
  const aria = `Aktueller Preis ${nf.format(cur)}, niedrigster ${nf.format(low)}, höchster ${nf.format(high)} – Einschätzung: ${label}.`;
  el.setAttribute('aria-label', aria);

  // SEO: JSON‑LD (Product + Offer)
  const jsonld = {
    '@context': 'https://schema.org',
    '@type': 'Product',
    name: name,
    image: image ? [image] : undefined,
    url: url,
    offers: {
      '@type': 'Offer',
      url: offerUrl || url,
      priceCurrency: currency,
      price: cur.toFixed(2),
      availability: `https://schema.org/${availability}`
    }
  };
  const s = document.createElement('script');
  s.type = 'application/ld+json';
  s.textContent = JSON.stringify(jsonld);
  document.head.appendChild(s);
})();
</script>
