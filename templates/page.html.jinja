{# ui-version:2025-08-11-v7 #}
<article class="page">
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <a href="/">Start</a> <span aria-hidden="true">›</span>
    {% if hub %}<a href="{{ hub.url }}">{{ hub.title }}</a> <span aria-hidden="true">›</span>{% endif %}
    <span aria-current="page">{{ game.title }}</span>
  </nav>

  <header class="hero">
    <h1 class="title">{{ game.title }}</h1>
    {% if game.subtitle %}<p class="subtitle">{{ game.subtitle }}</p>{% endif %}
    {% if offers and offers|length > 0 %}
    {% set best = offers[0] %}
    <section class="best-price" aria-label="Bestpreis">
      <div class="bp-main">
        <span class="bp-price">{{ '%.2f'|format(best.total_eur or best.price_eur) }}&nbsp;€</span>
        {% if best.shop %}<span class="bp-shop">{{ best.shop }}</span>{% endif %}
        {% if last_checked %}<span class="bp-time">Zuletzt geprüft: {{ last_checked.strftime('%d.%m.%Y %H:%M') }} Uhr</span>{% endif %}
      </div>
      <a class="btn btn-primary" href="{{ best.url }}" target="_blank" rel="nofollow sponsored noopener">Jetzt zum Deal</a>
      {% if min_price and avg7 %}
        {% set diff = ((min_price - avg7) / avg7 * 100) %}
        {% if diff <= -5 %}
          <p class="bp-indicator">🟢 {{ diff|abs|round(0) }}% unter 7‑Tage-Ø</p>
        {% elif diff < 5 %}
          <p class="bp-indicator">🟠 etwa auf 7‑Tage-Ø</p>
        {% else %}
          <p class="bp-indicator">🔴 {{ diff|abs|round(0) }}% über 7‑Tage-Ø</p>
        {% endif %}
      {% endif %}
    </section>
    {% endif %}
    <ul class="chips">
      {% if game.players %}<li class="chip">👥 {{ game.players.min }}–{{ game.players.max }} Spieler</li>{% endif %}
      {% if game.playtime %}<li class="chip">⏱️ {{ game.playtime.min }}–{{ game.playtime.max }} Min</li>{% endif %}
      {% if game.complexity %}<li class="chip">🧠 Komplexität {{ '%.1f'|format(game.complexity) }}</li>{% endif %}
      {% if game.year %}<li class="chip">📅 {{ game.year }}</li>{% endif %}
    </ul>
  </header>

  {% if missing_fields %}
  <p class="muted">⚠️ Fehlende YAML-Werte: {{ missing_fields|join(', ') }}</p>
  {% endif %}
  <div class="price-top">
    <section class="price-indicator" role="group" aria-label="Preisindikator">
      <div class="pi-header">
        <span class="pi-title">Preisindikator</span>
        <span class="pi-badge" id="pi-badge" aria-live="polite">–</span>
      </div>

      <p class="pi-note">≤−5&nbsp;% gut / ±5&nbsp;% ok / ≥+5&nbsp;% teuer</p>

      <div class="pi-bar" aria-hidden="true">
        <div class="pi-marker" id="pi-marker" title="Aktueller Preis"></div>
      </div>

      <dl class="pi-stats">
        <div><dt>Aktuell<span class="info-icon" title="Niedrigster Gesamtpreis heute inkl. Versand">ℹ</span></dt><dd id="pi-current">–</dd></div>
        <div><dt>Ø {{ avg_days }} Tage<span class="info-icon" title="Durchschnittlicher Gesamtpreis der letzten {{ avg_days }} Tage">ℹ</span></dt><dd id="pi-avg">–</dd></div>
      </dl>

      <div class="cta-row">
        {% if offers and offers|length > 0 %}
        <a class="btn btn-primary" href="#angebote" onclick="document.getElementById('angebote').scrollIntoView({behavior:'smooth'});return false;">Jetzt Angebote ansehen</a>
        {% else %}
        <a class="btn btn-primary" href="{{ ebay_search_url }}" target="_blank" rel="nofollow sponsored noopener">Jetzt Angebote ansehen</a>
        {% endif %}
      </div>
    </section>

  <section class="price-history">
    <h2 class="h2">Preisverlauf (30 Tage)<span class="info-icon" title="Tägliche Bestpreise der letzten {{ hist_days }} Tage">ℹ</span></h2>
    {% if avg30 %}
      <p class="avg-price">Durchschnitt ({{ hist_days }} Tage): {{ '%.2f'|format(avg30) }}&nbsp;€</p>
    {% else %}
      <p class="muted">Noch keine Preisdaten.</p>
    {% endif %}
    <div class="price-chart"><canvas id="priceHistoryChart"></canvas></div>
  </section>

  <section class="content-section">
    <h2 class="h2">Kaufberatung</h2>
    {% set primary_text = game.summary or game.description or game.about or game.intro or game.overview or game.text %}
    {% set paragraphs = game.kaufberatung or game.paragraphs or game.extra_paragraphs %}
    {% if primary_text %}{{ primary_text | md | safe }}{% endif %}
    {% if paragraphs %}{% for p in paragraphs %}{{ p | md | safe }}{% endfor %}{% endif %}
    {% if not primary_text and not paragraphs %}
      <p class="muted">Keine Details hinterlegt – wir ergänzen diese Seite bald.</p>
    {% endif %}
  </section>

  {% set cl = game.get('checklist') or game.get('checklist_buy') %}
  {% if cl %}
  <section class="content-section">
    <h2 class="h2">Gebrauchtkauf – Checkliste</h2>
    <ul class="checklist">
      {% if cl is mapping %}
        {% for k,v in cl.items() %}<li><strong>{{ k }}:</strong> {{ v }}</li>{% endfor %}
      {% else %}
        {% for item in cl %}
          {% if item is mapping %}
            {% for k,v in item.items() %}<li><strong>{{ k }}:</strong> {{ v }}</li>{% endfor %}
          {% else %}
            <li>{{ item }}</li>
          {% endif %}
        {% endfor %}
      {% endif %}
    </ul>
  </section>
  {% endif %}
  <section class="offers" id="angebote">
    <div class="offers-head">
      <h2 class="h2">Angebote</h2>
      <small class="muted">Sortierung nach Gesamtpreis (aufsteigend), nur Angebote in EUR.{% if fetched_at %} – aktualisiert {{ fetched_at }}{% endif %}</small>
    </div>

    <p class="affiliate-note muted">Transparenz: Links mit „Zum Angebot“ sind Affiliate-Links. Kaufst du darüber, erhalten wir ggf. eine Provision – für dich bleibt der Preis gleich.</p>

    {% if offers and offers|length > 0 %}
      <div class="offer-grid">
        {% for o in offers %}
          {% set is_best = loop.first %}
          <article class="offer-card{% if is_best %} top{% endif %}" data-offer>
            {% if is_best %}<div class="badge">Bestpreis</div>{% endif %}
            {% if o.image_url %}<img class="offer-img" src="{{ o.image_url }}" alt="" loading="lazy">{% endif %}
            <h3 class="offer-title"><a href="{{ o.url }}" target="_blank" rel="nofollow sponsored noopener">{{ o.title }}</a></h3>
            <div class="offer-meta">
              <span class="price">{% if o.total_eur is number %}{{ '%.2f'|format(o.total_eur) }}&nbsp;€{% else %}–{% endif %}</span>
              {% if o.shop %}<span class="seller">{{ o.shop }}</span>{% endif %}
            </div>
            <a class="btn btn-secondary offer-link" href="{{ o.url }}" target="_blank" rel="nofollow sponsored noopener">Zum Angebot</a>
          </article>
        {% endfor %}
        {% if amazon_search_url %}
          <article class="offer-card" data-offer>
            <h3 class="offer-title"><a href="{{ amazon_search_url }}" target="_blank" rel="nofollow sponsored noopener">Amazon</a></h3>
            <div class="offer-meta"><span class="price">–</span></div>
            <a class="btn btn-secondary offer-link" href="{{ amazon_search_url }}" target="_blank" rel="nofollow sponsored noopener">Preis auf Amazon prüfen</a>
          </article>
        {% endif %}
      </div>
    {% else %}
      <p class="muted">Gerade keine passenden Angebote. Schau später wieder vorbei – die Seite aktualisiert sich regelmäßig.</p>
      {% if amazon_search_url %}
      <div class="cta-row">
        <a class="btn btn-secondary" href="{{ amazon_search_url }}" target="_blank" rel="nofollow sponsored noopener">Preis auf Amazon prüfen</a>
      </div>
      {% endif %}
    {% endif %}
  </section>

  <section class="price-indicator" role="group" aria-label="Preisindikator">
    <h2 class="h2">Preisindikator</h2>
    <div class="pi-header">
      <span class="pi-badge" id="pi-badge" aria-live="polite">–</span>
    </div>

    <div class="pi-bar" aria-hidden="true">
      <div class="pi-marker" id="pi-marker" title="Aktueller Preis"></div>
    </div>

    <dl class="pi-stats">
      <div><dt>Aktuell<span class="info-icon" title="Niedrigster Gesamtpreis heute inkl. Versand">ℹ</span></dt><dd id="pi-current">–</dd></div>
      <div><dt>Ø {{ avg_days }} Tage<span class="info-icon" title="Durchschnittlicher Gesamtpreis der letzten {{ avg_days }} Tage">ℹ</span></dt><dd id="pi-avg">–</dd></div>
    </dl>

    <p class="pi-note">
      Basis ist der tägliche Gesamtpreis (Preis&nbsp;+&nbsp;Versand). Wir vergleichen den aktuellen Bestpreis mit dem Durchschnitt der letzten {{ avg_days }} Tage. ≤−5&nbsp;% = grün, ±5&nbsp;% = orange, ≥+5&nbsp;% = rot.
    </p>

    <div class="cta-row">
      {% if offers and offers|length > 0 %}
      <a class="btn btn-primary" href="#angebote" onclick="document.getElementById('angebote').scrollIntoView({behavior:'smooth'});return false;">Jetzt Angebote ansehen</a>
      {% else %}
      <a class="btn btn-primary" href="{{ ebay_search_url }}" target="_blank" rel="nofollow sponsored noopener">Jetzt Angebote ansehen</a>
      {% endif %}
    </div>

    <h3>Preisverlauf (30 Tage)<span class="info-icon" title="Tägliche Bestpreise der letzten {{ hist_days }} Tage">ℹ</span></h3>
    {% if avg30 %}
      <p class="avg-price">Durchschnitt ({{ hist_days }} Tage): {{ '%.2f'|format(avg30) }}&nbsp;€</p>
    {% else %}
      <p class="muted">Noch keine Preisdaten.</p>
    {% endif %}
    <div class="price-chart"><canvas id="priceHistoryChart"></canvas></div>
  </section>

  <section class="content-section">
    <h2 class="h2">Kaufberatung</h2>
    {% set primary_text = game.summary or game.description or game.about or game.intro or game.overview or game.text %}
    {% set paragraphs = game.kaufberatung or game.paragraphs or game.extra_paragraphs %}
    {% if primary_text %}{{ primary_text | md | safe }}{% endif %}
    {% if paragraphs %}{% for p in paragraphs %}{{ p | md | safe }}{% endfor %}{% endif %}
    {% if not primary_text and not paragraphs %}
      <p class="muted">Keine Details hinterlegt – wir ergänzen diese Seite bald.</p>
    {% endif %}
    {% set cl = game.get('checklist') or game.get('checklist_buy') %}
    {% if cl %}
      <h3>Gebrauchtkauf – Checkliste</h3>
      <ul class="checklist">
        {% if cl is mapping %}
          {% for k,v in cl.items() %}<li><strong>{{ k }}:</strong> {{ v }}</li>{% endfor %}
        {% else %}
          {% for item in cl %}
            {% if item is mapping %}
              {% for k,v in item.items() %}<li><strong>{{ k }}:</strong> {{ v }}</li>{% endfor %}
            {% else %}
              <li>{{ item }}</li>
            {% endif %}
          {% endfor %}
        {% endif %}
      </ul>
    {% endif %}
  </section>

  {% if game.alternatives %}
  <section class="content-section">
    <h2 class="h2">Alternativen</h2>
    <ul class="alt-list">
      {% for alt in game.alternatives %}
        {% set atitle = (alt.title if alt is mapping else alt) %}
        {% set aurl = (alt.url if alt is mapping else None) %}
        {% set aslug = (alt.slug if (alt is mapping and alt.slug) else None) %}
        <li>
          {% if aurl %}
            <a href="{{ aurl }}">{{ atitle }}</a>
          {% elif aslug %}
            <a href="/spiel/{{ aslug }}/">{{ atitle }}</a>
          {% else %}
            {{ atitle }}
          {% endif %}
          {% if alt is mapping and alt.note %}<span class="muted"> – {{ alt.note }}</span>{% endif %}
        </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <section class="content-section">
    <a class="btn btn-link" href="/alle-spiele.html">← Alle Spiele</a>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  window.addEventListener('DOMContentLoaded', function(){
    const hist = {{ history_json | safe }};
    if(hist.length){
      const ctx = document.getElementById('priceHistoryChart');
      const labels = hist.map(r=>r.date);
      const data = hist.map(r=>r.min);
      new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'Preis',data:data,borderColor:'#3e95cd',fill:false}]},options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback:(v)=>v+' €'}}}}});
    }
    {% if min_price and avg7 %}
    if (typeof window.renderPI === 'function'){
      window.renderPI({current: {{ '%.2f'|format(min_price) }}, avg7: {{ '%.2f'|format(avg7) }}});
    }
    {% endif %}
  });
  </script>
  <script type="application/ld+json">{{ breadcrumb_json | safe }}</script>

  {% set prices = (offers | map(attribute='price_eur') | reject('equalto', None) | list) if offers else [] %}
  {% set low = (prices|min) if prices else 0 %}
  {% set high = (prices|max) if prices else 0 %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "{{ game.title|e }}",
    "category": "Board game",
    {% if game.year %}"releaseDate": "{{ game.year }}",{% endif %}
    {% if offers and offers|length > 0 %}
    "offers": {
      "@type": "AggregateOffer",
      "priceCurrency": "EUR",
      "lowPrice": "{{ '%.2f'|format(low) }}",
      "highPrice": "{{ '%.2f'|format(high) }}",
      "offerCount": "{{ offers|length }}"
    },
    {% endif %}
    "url": "{{ (canonical or site_url ~ '/spiel/' ~ game.slug ~ '/')|e }}"
  }
  </script>
</article>
