{# ui-version:2025-08-11-v7 #}
{% set best = (offers[0] if offers else None) %}
<article class="page">
  <nav class="breadcrumb" aria-label="Breadcrumb">
    <a href="/">Start</a> <span aria-hidden="true">‚Ä∫</span>
    {% if hub %}<a href="{{ hub.url }}">{{ hub.title }}</a> <span aria-hidden="true">‚Ä∫</span>{% endif %}
    <span aria-current="page">{{ game.title }}</span>
  </nav>

  <header class="hero">
    <h1 class="title">{{ game.title }}</h1>
    <ul class="chips">
      {% if game.editions and game.editions.recommended %}
        {% set parts = game.editions.recommended.split('(') %}
        {% set edition = parts[0].strip() %}
        {% if edition %}<li class="chip">{{ edition }}</li>{% endif %}
        {% if parts|length > 1 %}
          {% set lang_raw = parts[1].replace(')', '').strip().lower() %}
          {% set lang_map = {'deutsch':'DE','de':'DE','englisch':'EN','en':'EN'} %}
          {% set lang = lang_map.get(lang_raw, lang_raw|upper) %}
          {% if lang %}<li class="chip">{{ lang }}</li>{% endif %}
        {% endif %}
      {% endif %}
      {% if game.players %}<li class="chip">üë• {{ game.players.min }}‚Äì{{ game.players.max }} Spieler</li>{% endif %}
      {% if game.playtime %}<li class="chip">‚è±Ô∏è {{ game.playtime.min }}‚Äì{{ game.playtime.max }} Min</li>{% endif %}
      {% if game.complexity %}<li class="chip">üß† Komplexit√§t {{ '%.1f'|format(game.complexity) }}</li>{% endif %}
      {% if game.year %}<li class="chip">üìÖ {{ game.year }}</li>{% endif %}
    </ul>
  </header>

{% set price_indicator %}
<section id="preisindikator" class="bpr-price-indicator" aria-labelledby="preisindikator__title"
  data-currency="EUR"
  data-product-name="{{ game.title }}"
  data-product-url="https://brettspielpreisradar.de/spiel/{{ game.slug }}/"
  {% if best and best.image_url %}data-product-image="{{ best.image_url }}"{% endif %}
  {% if min_price is not none %}data-current="{{ '%.2f'|format(min_price) }}"{% endif %}
  {% if avg7 %}data-seven-day-average="{{ '%.2f'|format(avg7) }}"{% endif %}
  data-history='{{ history_json | safe }}'
  {% if best and best.url %}data-offer-url="{{ best.url }}"{% endif %}
  data-availability="{% if offers %}InStock{% else %}OutOfStock{% endif %}">
  <div class="bpr-card">
    <header class="bpr-header">
      <h2 id="preisindikator__title" class="bpr-title">Preisindikator</h2>
      <div class="bpr-pill" role="status" aria-live="polite" aria-atomic="true">
        <span class="bpr-pill__dot" aria-hidden="true"></span>
        <span class="bpr-pill__label">‚Äì</span>
      </div>
    </header>
    <div class="bpr-grid">
      <div class="bpr-main">
        <div class="bpr-price">
          <div class="bpr-price__label">Aktuell</div>
          <div class="bpr-price__value" data-field="current">‚Äì ‚Ç¨</div>
          <div class="bpr-price__delta" data-field="delta">‚Äì%</div>
        </div>
        <div class="bpr-metrics" role="group" aria-label="Preis-Kennzahlen">
          <div class="bpr-metric">
            <div class="bpr-metric__label">√ò 7 Tage</div>
            <div class="bpr-metric__value" data-field="avg7">‚Äì ‚Ç¨</div>
          </div>
          <div class="bpr-metric">
            <div class="bpr-metric__label">30-Tage-Tief</div>
            <div class="bpr-metric__value" data-field="low30">‚Äì ‚Ç¨</div>
          </div>
          <div class="bpr-metric">
            <div class="bpr-metric__label">30-Tage-Hoch</div>
            <div class="bpr-metric__value" data-field="high30">‚Äì ‚Ç¨</div>
          </div>
        </div>
        <div class="bpr-gauge" role="img" aria-label="aktueller Preis relativ zum 30‚ÄëTage‚ÄëSpektrum">
          <div class="bpr-gauge__track" aria-hidden="true"></div>
          <div class="bpr-gauge__fill" aria-hidden="true"></div>
          <div class="bpr-gauge__marker" aria-hidden="true"><span>Jetzt</span></div>
          <div class="bpr-gauge__legend">
            <span class="bpr-gauge__min" data-field="low30">‚Äì ‚Ç¨</span>
            <span class="bpr-gauge__mid">√ò</span>
            <span class="bpr-gauge__max" data-field="high30">‚Äì ‚Ç¨</span>
          </div>
        </div>
      </div>
      <div class="bpr-side">
        {% if best and best.url %}
        {% set sep = '?' if '?' not in best.url else '&' %}
        <a class="bpr-cta" href="{{ best.url ~ sep ~ 'utm_source=bpr&utm_medium=offer&utm_campaign=' ~ game.slug }}" rel="nofollow sponsored" data-field="offerUrl">
          <span class="bpr-cta__label">Zum Angebot</span>
          <span class="bpr-cta__price" data-field="current">‚Äì ‚Ç¨</span>
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</section>
{% endset %}

{% if best %}
{% set diff = ((min_price - avg7) / avg7 * 100) if (min_price and avg7) else None %}
<div class="hero-offers">
  <section class="best-price" aria-label="Bestpreis">
    <div class="bp-main">
      <span class="bp-price">{{ '%.2f'|format(best.total_eur or best.price_eur) }}&nbsp;‚Ç¨</span>
      {% if best.shop %}<span class="bp-shop">{{ best.shop }}</span>{% endif %}
      {% if last_checked %}<span class="bp-time">Zuletzt gepr√ºft: {{ last_checked.strftime('%d.%m.%Y %H:%M') }} Uhr</span>{% endif %}
    </div>
    {% if best.image_url %}<img class="bp-img" src="{{ best.image_url }}" alt="" loading="lazy">{% endif %}
    {% if best.url %}
    {% set sep = '?' if '?' not in best.url else '&' %}
    {% set bp = '%.2f'|format(best.total_eur or best.price_eur) %}
    <a class="btn btn-primary" id="dealBtn" href="{{ best.url ~ sep ~ 'utm_source=bpr&utm_medium=offer&utm_campaign=' ~ game.slug }}" onclick="click_offer('{{ best.shop }}','{{ game.slug }}','{{ bp }}')" target="_blank" rel="nofollow sponsored noopener">Jetzt f√ºr {{ bp }}‚Ç¨{% if best.shop %} bei {{ best.shop }}{% endif %} kaufen</a>
    {% endif %}
    {% if diff is not none %}
    <div class="bp-badges">
      <span class="badge-grey">{% if diff >= 0 %}+{{ diff|round(0) }}%{% else %}{{ diff|round(0) }}%{% endif %} vs. 7‚ÄëTage‚Äë√ò</span>
      {% if is_best_90 %}<span class="badge-grey">Bestpreis (90 Tage)</span>{% endif %}
    </div>
    {% endif %}
  </section>
  {{ price_indicator | safe }}
</div>
{% else %}
  {{ price_indicator | safe }}
{% endif %}

  <section class="offers" id="angebote">
    <div class="offers-head">
      <h2 class="h2">Preisvergleich</h2>
    </div>
    <p class="affiliate-note muted">Hinweis: Links mit ‚ÄûZum Angebot‚Äú sind Affiliate-Links.</p>
    {% if offers and offers|length > 0 %}
    <table class="price-table">
      <thead>
        <tr>
          <th>Angebot</th>
          <th>Preis</th>
          <th>Zustand</th>
          <th>Shop</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for o in offers %}
          {% set extra = loop.index > 4 %}
          {% set sep = '?' if '?' not in o.url else '&' %}
          <tr class="offer-row{% if loop.first %} row--best{% endif %}{% if extra %} extra{% endif %}" {% if extra %}style="display:none"{% endif %} data-offer>
            <td class="cell cell--title">
              <div class="offer-main">
                {% if o.image_url %}<img class="offer-img" src="{{ o.image_url }}" alt="" loading="lazy">{% endif %}
                <div>
                  <a class="title" href="{{ o.url ~ sep ~ 'utm_source=bpr&utm_medium=offer&utm_campaign=' ~ game.slug }}" target="_blank" rel="nofollow sponsored noopener">{{ o.title }}</a>
                  {% if loop.first %}<span class="badge badge--best">Bestpreis</span>{% endif %}
                </div>
              </div>
            </td>
            <td class="cell cell--price">
              <span class="price">{% if o.total_eur is number %}{{ '%.2f'|format(o.total_eur) }}&nbsp;‚Ç¨{% else %}‚Äì{% endif %}</span>
            </td>
            <td class="cell cell--cond">{% if o.condition %}{{ o.condition }}{% endif %}</td>
            <td class="cell cell--shop">{% if o.shop %}<span class="shop">{{ o.shop }}</span>{% endif %}</td>
            <td class="cell cell--cta">
              <a class="btn btn-cta" href="{{ o.url ~ sep ~ 'utm_source=bpr&utm_medium=offer&utm_campaign=' ~ game.slug }}" onclick="click_offer('{{ o.shop }}','{{ game.slug }}','{{ o.total_eur or o.price_eur }}')" target="_blank" rel="nofollow sponsored noopener">Zum Angebot</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    {% if offers|length > 4 %}
    <div class="cta-row"><button id="moreOffersBtn" class="btn btn-link">Weitere Angebote anzeigen</button></div>
    {% endif %}
    {% else %}
      <p class="muted">Gerade keine passenden Angebote. Schau sp√§ter wieder vorbei ‚Äì die Seite aktualisiert sich regelm√§√üig.</p>
    {% endif %}
    {% if amazon_search_url %}
    <section class="content-section amazon-tile">
      <a class="btn btn-secondary" href="{{ amazon_search_url }}" target="_blank" rel="nofollow sponsored noopener">Preis auf Amazon pr√ºfen</a>
    </section>
    {% endif %}
  </section>

  <section class="price-history">
    <h2 class="h2">Preisverlauf (30 Tage)<span class="info-icon" title="T√§gliche Bestpreise der letzten {{ hist_days }} Tage">‚Ñπ</span></h2>
    {% if avg30 %}
      <p class="avg-price">Durchschnitt ({{ hist_days }} Tage): {{ '%.2f'|format(avg30) }}&nbsp;‚Ç¨</p>
    {% else %}
      <p class="muted">Noch keine Preisdaten.</p>
    {% endif %}
    <div class="price-chart"><canvas id="priceHistoryChart"></canvas></div>
  </section>

  <section class="content-section">
    <h2 class="h2">Kaufberatung</h2>
    {% set primary_text = game.summary or game.description or game.about or game.intro or game.overview or game.text %}
    {% set paragraphs = game.kaufberatung or game.paragraphs or game.extra_paragraphs %}
    {% if primary_text %}{{ primary_text | md | safe }}{% endif %}
    {% if paragraphs %}{% for p in paragraphs %}{{ p | md | safe }}{% endfor %}{% endif %}
    {% if not primary_text and not paragraphs %}
      <p class="muted">Keine Details hinterlegt ‚Äì wir erg√§nzen diese Seite bald.</p>
    {% endif %}
  </section>

  {% set cl = game.get('checklist') or game.get('checklist_buy') %}
  {% if cl %}
  <section class="content-section">
    <h2 class="h2">Gebrauchtkauf ‚Äì Checkliste</h2>
    <ul class="checklist">
      {% if cl is mapping %}
        {% for k,v in cl.items() %}<li><strong>{{ k }}:</strong> {{ v }}</li>{% endfor %}
      {% else %}
        {% for item in cl %}
          {% if item is mapping %}
            {% for k,v in item.items() %}<li><strong>{{ k }}:</strong> {{ v }}</li>{% endfor %}
          {% else %}
            <li>{{ item }}</li>
          {% endif %}
        {% endfor %}
      {% endif %}
    </ul>
  </section>
  {% endif %}

  {% if game.alternatives %}
  <section class="content-section">
    <h2 class="h2">Alternativen</h2>
    <ul class="alt-list">
      {% for alt in game.alternatives %}
        {% set atitle = (alt.title if alt is mapping else alt) %}
        {% set aurl = (alt.url if alt is mapping else None) %}
        {% set aslug = (alt.slug if (alt is mapping and alt.slug) else None) %}
        <li>
          {% if aurl %}
            <a href="{{ aurl }}">{{ atitle }}</a>
          {% elif aslug %}
            <a href="/spiel/{{ aslug }}/">{{ atitle }}</a>
          {% else %}
            {{ atitle }}
          {% endif %}
          {% if alt is mapping and alt.note %}<span class="muted"> ‚Äì {{ alt.note }}</span>{% endif %}
        </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  {% if game.faqs %}
  <section class="content-section faq">
    <h2 class="h2">FAQ</h2>
    <div class="faq">
      {% for f in game.faqs %}
      <details>
        <summary>{{ f.q }}</summary>
        <div class="answer">{{ f.a }}</div>
      </details>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="content-section">
    <a class="btn btn-link" href="/alle-spiele.html">‚Üê Alle Spiele</a>
  </section>

  {% if best and best.url %}
  <div class="sticky-buy-bar" id="stickyBuyBar"></div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  window.addEventListener('DOMContentLoaded', function(){
    const hist = {{ history_json | safe }};
    if(hist.length){
      const ctx = document.getElementById('priceHistoryChart');
      const labels = hist.map(r=>r.date);
      const data = hist.map(r=>r.min);
      new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'Preis',data:data,borderColor:'#3e95cd',fill:false}]},options:{plugins:{legend:{display:false}},scales:{y:{ticks:{callback:(v)=>v+' ‚Ç¨'}}}}});
    }
    
    var moreBtn=document.getElementById('moreOffersBtn');
    if(moreBtn){
      moreBtn.addEventListener('click',function(){
        document.querySelectorAll('.offer-row.extra').forEach(function(el){
          el.style.removeProperty('display');
        });
        moreBtn.remove();
      });
    }
    var sticky=document.getElementById('stickyBuyBar');
    var dealBtn=document.getElementById('dealBtn');
    if(sticky && dealBtn && window.matchMedia('(max-width:719px)').matches){
      var stickyBtn=dealBtn.cloneNode(true);
      stickyBtn.id='stickyDealBtn';
      sticky.appendChild(stickyBtn);
      var observer=new IntersectionObserver(function(entries){
        entries.forEach(function(entry){
          sticky.classList.toggle('show', !entry.isIntersecting);
        });
      });
      observer.observe(dealBtn);
    }

    var priceHistory=document.querySelector('.price-history');
    var priceIndicator=document.querySelector('.bpr-price-indicator');
    if(priceHistory && priceIndicator && window.matchMedia('(max-width:719px)').matches){
      priceIndicator.insertAdjacentElement('afterend', priceHistory);
    }
  });
  </script>
  <script>
  (function(){
    const el=document.querySelector('#preisindikator');
    if(!el) return;
    const currency=el.dataset.currency||'EUR';
    const name=el.dataset.productName||document.querySelector('h1')?.textContent?.trim()||'Produkt';
    const url=el.dataset.productUrl||location.href;
    const image=el.dataset.productImage||'';
    const offerUrl=el.dataset.offerUrl||'#';
    const availability=el.dataset.availability||'InStock';
    const cur=Number(el.dataset.current||0);
    const avg7=Number(el.dataset.sevenDayAverage||0);
    let history=[];
    try{history=JSON.parse(el.dataset.history||'[]');}catch(e){history=[];}
    if(history.length&&typeof history[0]==='object'){history=history.map(h=>h.min);}
    const nf=new Intl.NumberFormat('de-DE',{style:'currency',currency});
    const pctf=new Intl.NumberFormat('de-DE',{maximumFractionDigits:1,minimumFractionDigits:1});
    const low30=history.length?Math.min(...history):Math.min(cur,avg7||cur);
    const high30=history.length?Math.max(...history):Math.max(cur,avg7||cur);
    const delta=avg7?((cur-avg7)/avg7):0;
    let statusLabel='OK';
    let statusTone='ok';
    if(delta<=-0.10){statusLabel='Top‚ÄëDeal';statusTone='good';}
    else if(delta<=-0.03){statusLabel='Gut';statusTone='good';}
    else if(Math.abs(delta)<=0.03){statusLabel='OK';statusTone='ok';}
    else{statusLabel='Hoch';statusTone='high';}
    el.querySelectorAll('[data-field="current"]').forEach(n=>n.textContent=nf.format(cur));
    const avgEl=el.querySelector('[data-field="avg7"]');if(avgEl)avgEl.textContent=nf.format(avg7||cur);
    el.querySelectorAll('[data-field="low30"]').forEach(n=>n.textContent=nf.format(low30));
    el.querySelectorAll('[data-field="high30"]').forEach(n=>n.textContent=nf.format(high30));
    const deltaEl=el.querySelector('[data-field="delta"]');
    if(deltaEl){const sign=delta>0?'+':'';deltaEl.textContent=`${sign}${pctf.format(delta*100)} vs. 7‚ÄëTage‚Äë√ò`;}
    const pill=el.querySelector('.bpr-pill');
    if(pill){
      const dot=pill.querySelector('.bpr-pill__dot');
      const lab=pill.querySelector('.bpr-pill__label');
      if(dot) dot.style.background=statusTone==='good'?'var(--bpr-good)':statusTone==='ok'?'var(--bpr-ok)':'var(--bpr-high)';
      if(lab) lab.textContent=statusLabel;
    }
    const cta=el.querySelector('.bpr-cta');
    if(cta) cta.href=offerUrl||'#';
    const gaugeFill=el.querySelector('.bpr-gauge__fill');
    const gaugeMarker=el.querySelector('.bpr-gauge__marker');
    const range=Math.max(0.01,high30-low30);
    const pct=Math.max(0,Math.min(1,(cur-low30)/range));
    const pctMid=avg7?Math.max(0,Math.min(1,(avg7-low30)/range)):0.5;
    if(gaugeFill) gaugeFill.style.width=`${pct*100}%`;
    if(gaugeMarker) gaugeMarker.style.left=`${pct*100}%`;
    const mid=el.querySelector('.bpr-gauge__mid');
    if(mid) mid.style.transform=`translateX(${(pctMid*100-50)*.2}%)`;
    const jsonld={
      '@context':'https://schema.org',
      '@type':'Product',
      name:name,
      image:image?[image]:undefined,
      url:url,
      offers:{'@type':'Offer',url:offerUrl||url,priceCurrency:currency,price:cur.toFixed(2),availability:`https://schema.org/${availability}`}
    };
    const s=document.createElement('script');
    s.type='application/ld+json';
    s.textContent=JSON.stringify(jsonld);
    document.head.appendChild(s);
  })();
  </script>
  <script type="application/ld+json">{{ breadcrumb_json | safe }}</script>

  {% set prices = (offers | map(attribute='price_eur') | reject('equalto', None) | list) if offers else [] %}
  {% set low = (prices|min) if prices else 0 %}
  {% set high = (prices|max) if prices else 0 %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Product",
    "name": "{{ game.title|e }}",
    "category": "Board game",
    {% if game.year %}"releaseDate": "{{ game.year }}",{% endif %}
    {% if offers and offers|length > 0 %}
    "offers": {
      "@type": "AggregateOffer",
      "priceCurrency": "EUR",
      "lowPrice": "{{ '%.2f'|format(low) }}",
      "highPrice": "{{ '%.2f'|format(high) }}",
      "offerCount": "{{ offers|length }}"
    },
    {% endif %}
    "url": "{{ (canonical or site_url ~ '/spiel/' ~ game.slug ~ '/')|e }}"
  }
  </script>
</article>
